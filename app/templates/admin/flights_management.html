{% extends "base.html" %} {% block title %}Flights Management - SmallGoods{%
endblock %} {% block css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/admin/flights_management.css') }}"
/>
{% endblock %} {% block content %}

<!-- Data Storage Script - Populate JavaScript with SSR data -->
<script>
console.log("Setting up flight management data from server...");

// Make data available to JavaScript
window.flightManagementData = {
  competitions: {{ competitions | tojson }},
  events: {{ events | tojson }},
  athletes: {{ athletes | tojson }},
  flights: {{ flights | tojson }}
};

console.log("Flight management data loaded:");
console.log("  - Competitions:", window.flightManagementData.competitions.length, "items");
console.log("  - Events:", window.flightManagementData.events.length, "items"); 
console.log("  - Athletes:", window.flightManagementData.athletes.length, "items");
console.log("  - Flights:", window.flightManagementData.flights.length, "items");

// Verify hierarchical structure
console.log("Competition hierarchy preview:");
window.flightManagementData.competitions.slice(0, 2).forEach(comp => {
  console.log(`  Competition "${comp.name}" (ID: ${comp.id}):`);
  console.log(`    - Events: ${comp.events ? comp.events.length : 0}`);
  console.log(`    - Direct flights: ${comp.flights ? comp.flights.length : 0}`);
});

console.log("Data setup complete - no localStorage used");
</script>

<div class="flights-management">
  <div class="header-section">
    <h1>Flights Management</h1>
    <button class="btn btn-primary" id="add-flight-btn">
      <i class="icon-plus"></i> Add New Flight
    </button>
  </div>

  <!-- Competition and Event Selection -->
  <div class="selection-section">
    <div class="selection-controls">
      <div class="form-group">
        <label for="competition-select">Competition:</label>
        <select id="competition-select">
          <option value="">Select Competition</option>
          {% for competition in competitions %}
          <option value="{{ competition.id }}">{{ competition.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="event-select">Event:</label>
        <select id="event-select" disabled>
          <option value="">Select Event</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Flights Container -->
  <div class="flights-container" id="flights-container">
    <div class="empty-state" id="empty-state">
      <h3>No Event Selected</h3>
      <p>
        Please select a competition and event to manage flights, or view all
        flights below.
      </p>
    </div>

    <!-- Flights List (will be populated via JavaScript) -->
    <div class="flights-list" id="flights-list" style="display: none">
      <div class="flights-header">
        <h2>Flight Order Management</h2>
        <p>
          Drag and drop to reorder flights. Changes are saved automatically.
        </p>
      </div>

      <!-- Search and Filter Controls -->
      <div class="flights-controls">
        <div class="search-controls">
          <input
            type="text"
            id="flight-search"
            placeholder="Search flights..."
            class="search-input"
          />
        </div>
        <div class="filter-controls">
          <select id="competition-filter" class="filter-select">
            <option value="">All Competitions</option>
            {% for competition in competitions %}
            <option value="{{ competition.name }}">
              {{ competition.name }}
            </option>
            {% endfor %}
          </select>
          <select id="status-filter" class="filter-select">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <select id="event-filter" class="filter-select">
            <option value="">All Events</option>
          </select>
          <select id="movement-filter" class="filter-select">
            <option value="">All Movements</option>
            <option value="snatch">Snatch</option>
            <option value="clean_jerk">Clean & Jerk</option>
            <option value="squat">Squat</option>
            <option value="bench">Bench Press</option>
            <option value="deadlift">Deadlift</option>
          </select>
        </div>
      </div>

      <div class="flights-grid" id="flights-grid">
        <!-- SSR rendered flight cards -->
        {% for flight in flights %}
        <div class="flight-card" data-flight-id="{{ flight.id }}" data-competition-id="{{ flight.competition_id or '' }}" data-event-id="{{ flight.event_id or '' }}" data-movement-type="{{ flight.movement_type or '' }}">
          <div class="flight-header">
            <h3>{{ flight.name }}</h3>
            <div class="flight-order">Order: {{ flight.order }}</div>
          </div>
          <div class="flight-info">
            <p><strong>Competition:</strong> {{ flight.competition_name or 'No Competition' }}</p>
            <p><strong>Event:</strong> {{ flight.event_name or 'No Event' }}</p>
            <p><strong>Movement:</strong> {{ flight.movement_type or 'No Movement' }}</p>
            <p><strong>Athletes:</strong> {{ flight.athlete_count }}</p>
            <p><strong>Status:</strong> 
              <span class="status-badge {{ 'active' if flight.is_active else 'inactive' }}">
                {{ 'Active' if flight.is_active else 'Inactive' }}
              </span>
            </p>
          </div>
          <div class="flight-actions">
            <button class="btn btn-sm btn-primary manage-athletes" data-flight-id="{{ flight.id }}">
              Manage Athletes
            </button>
            <button class="btn btn-sm btn-secondary edit-flight" data-flight-id="{{ flight.id }}">
              Edit
            </button>
            <button class="btn btn-sm btn-danger delete-flight" data-flight-id="{{ flight.id }}">
              Delete
            </button>
          </div>
        </div>
        {% endfor %}
        
        {% if not flights %}
        <div class="empty-state">
          <h3>No Flights Found</h3>
          <p>No flights have been created yet. Click "Add New Flight" to get started.</p>
        </div>
        {% endif %}
      </div>

      <!-- Pagination -->
      <div
        class="pagination-container"
        id="flights-pagination"
        style="display: none"
      >
        <div class="pagination-info" id="flights-pagination-info">
          Showing 1 to 10 of 50 flights
        </div>
        <div class="pagination" id="flights-pagination-controls">
          <!-- Pagination controls will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Flight Athletes Management -->
  <div
    class="flight-athletes-section"
    id="flight-athletes-section"
    style="display: none"
  >
    <div class="section-header">
      <h2>Flight Athletes</h2>
      <div class="flight-info">
        <span id="current-flight-name">Flight A</span>
        <span id="current-flight-order">Order: 1</span>
        <div
          id="current-flight-info"
          style="
            display: none;
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.5rem;
          "
        ></div>
      </div>
    </div>

    <div class="athletes-management">
      <div class="available-athletes">
        <h3>Available Athletes</h3>
        <div class="athletes-search">
          <input
            type="text"
            id="available-search"
            placeholder="Search available athletes..."
          />
        </div>
        <div class="athletes-list" id="available-athletes-list">
          <!-- Available athletes will be populated here -->
        </div>
        <div
          class="athletes-pagination"
          id="available-athletes-pagination"
          style="display: none"
        >
          <!-- Pagination controls will be added here by JavaScript -->
        </div>
      </div>

      <div class="flight-athletes">
        <h3>Athletes in Flight</h3>
        <div class="athletes-list" id="flight-athletes-list">
          <!-- Flight athletes will be populated here -->
        </div>
      </div>
    </div>

    <div class="attempt-order-section">
      <h3>Attempt Order Management</h3>
      <p class="attempt-instructions">
        <i class="icon-info"></i> Drag athlete boxes to reorder, or use the buttons below to sort automatically. All changes are saved automatically.
      </p>
      
      <!-- Attempt Filter Controls -->
      <div class="attempt-filter-controls">
        <div class="filter-group">
          <label for="athlete-name-filter">Filter by Athlete:</label>
          <input type="text" id="athlete-name-filter" placeholder="Search athlete name..." class="filter-input">
        </div>
        <div class="filter-group">
          <label for="attempt-status-filter">Filter by Status:</label>
          <select id="attempt-status-filter" class="filter-select">
            <option value="">All Status</option>
            <option value="waiting">Waiting</option>
            <option value="in-progress">In Progress</option>
            <option value="finished">Finished</option>
          </select>
        </div>
        <button class="btn btn-secondary" id="clear-filters">Clear Filters</button>
      </div>
      
      <div class="attempt-controls">
        <button class="btn btn-secondary" id="sort-by-weight">
          Sort by Weight
        </button>
        <button class="btn btn-secondary" id="sort-by-name">
          Sort by Name
        </button>
        <button class="btn btn-secondary" id="randomize-order">
          Randomize Order
        </button>
        <button class="btn btn-info" id="generate-test-attempts">
          Generate Test Attempts
        </button>
        <button class="btn btn-warning" id="mark-first-completed">
          Mark First as Completed
        </button>
        <button class="btn btn-primary" id="refresh-attempts">
          Refresh
        </button>
      </div>
      <div class="attempt-order-list" id="attempt-order-list">
        <!-- Attempt order will be displayed here -->
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Flight Modal -->
<div id="flight-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="flight-modal-title">Add New Flight</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <form id="flight-form">
        <div class="form-group">
          <label for="flight_name">Flight Name *</label>
          <input
            type="text"
            id="flight_name"
            name="flight_name"
            required
            placeholder="e.g., Flight A, Flight B"
          />
        </div>
        <div class="form-group">
          <label for="flight_competition_id">Competition *</label>
          <select id="flight_competition_id" name="competition_id" required>
            <option value="">Select Competition</option>
          </select>
        </div>
        <div class="form-group">
          <label for="flight_event_id">Event</label>
          <select id="flight_event_id" name="event_id">
            <option value="">Select Event (Optional)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="flight_movement_type">Movement Type</label>
          <select id="flight_movement_type" name="movement_type">
            <option value="">Select Movement (Optional)</option>
            <option value="snatch">Snatch</option>
            <option value="clean_jerk">Clean & Jerk</option>
            <option value="squat">Squat</option>
            <option value="bench">Bench Press</option>
            <option value="deadlift">Deadlift</option>
          </select>
        </div>
        <div class="form-group">
          <label for="flight_order">Order *</label>
          <input
            type="number"
            id="flight_order"
            name="flight_order"
            required
            min="1"
          />
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="flight_is_active" name="is_active" />
            Active Flight
          </label>
        </div>
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            id="cancel-flight-btn"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="save-flight-btn">
            Save Flight
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Flight Confirmation Modal -->
<div id="delete-flight-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <p>
        Are you sure you want to delete this flight? This will also remove all
        athletes from this flight.
      </p>
      <p><strong id="delete-flight-name"></strong></p>
    </div>
    <div class="form-actions">
      <button
        type="button"
        class="btn btn-secondary"
        id="cancel-delete-flight-btn"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-danger"
        id="confirm-delete-flight-btn"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Add/Edit Attempt Modal -->
<div id="attempt-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="attempt-modal-title">Add New Attempt</h2>
      <span class="close">&times;</span>
    </div>
    <div class="modal-body">
      <form id="attempt-form">
        <div class="form-group">
          <label for="attempt_number">Attempt Number *</label>
          <input type="number" id="attempt_number" name="attempt_number" min="1" max="3" required>
        </div>
        <div class="form-group">
          <label for="attempt_weight">Requested Weight (kg) *</label>
          <input type="number" id="attempt_weight" name="requested_weight" step="0.5" required>
        </div>
        <div class="form-group">
          <label for="attempt_status">Status</label>
          <select id="attempt_status" name="status">
            <option value="waiting">Waiting</option>
            <option value="in-progress">In Progress</option>
            <option value="finished">Finished</option>
          </select>
        </div>
        <div class="form-group">
          <label for="attempt_lifting_order">Lifting Order</label>
          <input type="number" id="attempt_lifting_order" name="lifting_order" min="1">
        </div>
      </form>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" id="cancel-attempt-btn">Cancel</button>
      <button type="button" class="btn btn-primary" id="save-attempt-btn">Save Attempt</button>
    </div>
  </div>
</div>

<a href="{{ url_for('admin.admin_dashboard') }}" class="back-link"
  >← Back to Admin Dashboard</a
>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/admin/flights_management.js') }}"></script>
{% endblock %}
