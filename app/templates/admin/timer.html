{% extends "base.html" %}
{% block title %}Timekeeper{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timekeeper.css') }}">

<!-- Fixed Mobile Control Dock (proxied buttons) -->
<div class="control-dock" aria-label="Timer controls">
  <button class="dock-btn start"  onclick="document.getElementById('btnStart').click()">▶</button>
  <button class="dock-btn pause"  onclick="document.getElementById('btnPause').click()">⏸</button>
  <button class="dock-btn stop"   onclick="document.getElementById('btnBarLeft').click()">■</button>
  <button class="dock-btn reset"  onclick="document.getElementById('btnReset').click()">↺</button>
</div>

<div class="container-fluid tk-v1">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">
        <span class="ico"></span> Timekeeper Dashboard
      </h1>

      <!-- Flight selector toolbar (top only) -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Select Flight</h5>
        </div>
        <div class="card-body">
          <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center">
            <label>Competition
              <select id="selComp" style="min-width:220px; margin-left:.5rem"></select>
            </label>
            <label>Event
              <select id="selEvent" style="min-width:220px; margin-left:.5rem" disabled></select>
            </label>
            <label>Flight
              <select id="selFlight" style="min-width:220px; margin-left:.5rem" disabled></select>
            </label>
            <button id="selGo" class="btn primary" disabled>Load</button>
          </div>
        </div>
      </div>

      <!-- Selected Flight -->
      <div class="card" id="tk-available-card" style="display:none">
        <div class="card-header">
          <h5><span class="ico"></span> Selected Flight</h5>
        </div>
        <div class="card-body" id="tk-competitions-body">
          <div class="text-center py-5" id="tk-competitions-empty">
            <div class="muted-ico"></div>
            <h4 class="text-muted">No selection</h4>
            <p class="text-muted">Choose a competition, event, and flight above.</p>
          </div>

          <!-- Summary -->
          <div id="tk-selected-summary" class="selected-wrap" style="display:none"></div>

          <!-- Athlete & Attempt chooser -->
          <div id="tk-athlete-editor" style="margin-top:1rem; display:none">
            <div style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap">
              <label style="font-weight:600">
                Athlete:
                <select id="athleteSelect"
                        style="margin-left:.5rem; min-width:260px; padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px;"
                        disabled>
                  <option value="">Select athlete…</option>
                </select>
              </label>

              <label style="font-weight:600">
                Attempt:
                <select id="attemptSelect"
                        style="margin-left:.5rem; min-width:120px; padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px;"
                        disabled>
                  <option value="">Select…</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </label>

              <button class="btn" id="btnReloadAthletes" type="button">Reload</button>
              <button class="btn" id="btnAthleteApply" type="button">Apply</button>
              <button class="btn btn-success" id="btnNextAthlete" type="button" style="background: #28a745; color: white;">Next</button>
              <span id="athleteApplied" class="text-muted" style="margin-left:.5rem"></span>

              <!-- TEMP compat input (hidden) -->
              <input id="athleteName" type="text" value="" style="display:none">
            </div>
          </div>

        </div>
      </div>

      <!-- Timer Controls -->
      <div class="card mt-4 hide-on-mobile">
        <div class="card-header">
          <h5><span class="ico"></span> Timer Controls</h5>
        </div>
        <div class="card-body">
          <div class="tc-grid">
            <button class="tile tile--start" id="btnStart" aria-label="Start Timer">
              <span class="tile-ico">▶</span><span class="tile-title">Start</span>
            </button>
            <button class="tile tile--pause" id="btnPause" aria-label="Pause Timer">
              <span class="tile-ico">⏸</span><span class="tile-title">Pause</span>
            </button>
            <button class="tile tile--stop" id="btnBarLeft" aria-label="Stop Timer">
              <span class="tile-ico">■</span><span class="tile-title">Stop</span>
            </button>
            <button class="tile tile--reset" id="btnReset" aria-label="Reset Timer">
              <span class="tile-ico">↺</span><span class="tile-title">Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden compatibility controls (attempt only; break removed) -->
      <div class="visually-hidden">
        <button id="btnResume"></button>
        <button id="btnAdd10"></button>
        <button id="btnSub10"></button>
        <button id="btn60"></button>
        <button id="btn120"></button>
        <input type="number" id="attemptSetSec" value="{{ default_attempt_seconds or 60 }}">
        <button id="btnApplyAttempt"></button>
        <label><input type="checkbox" id="chkAnn">Ann</label>
        <label><input type="checkbox" id="chkLoaded">Load</label>
      </div>

      <!-- Current Status -->
      <div class="card mt-4">
        <div class="card-header"><h5>Attempt Timer</h5></div>
        <div class="card-body status-wrap">
          <div class="status-top only-timer">
            <div class="status-top__timer">
              <div class="display-time display-time--hero" id="attemptClock">00:00:00</div>
              <div class="muted-sub">Current Timer</div>
            </div>
          </div>

          <div class="attempt-controls">
            <button id="btnAttemptToggle" class="btn" type="button">Countdown: Off</button>
            <div class="timer-set attempt-set" id="attemptSetRow" style="display:none">
              <label for="attemptHMS"><strong>Set</strong></label>
              <input id="attemptHMS" class="input-hms" type="text" inputmode="numeric"
                     placeholder="HH:MM:SS" value="00:01:00">
              <button class="btn" id="btnAttemptApply">Apply</button>
            </div>
          </div>

          <!-- NOTE: Global Break panel removed; we now use per-athlete Rest inside pinned cards -->
        </div>
      </div>

      <!-- Pinned Timers (per-athlete rest) -->
      <div class="card mt-4" id="pinnedTimersCard" style="display:none">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
          <h5>Rest/Break Timers</h5>
          <div class="btn-row" style="display:flex;gap:.5rem;">
            <button class="btn" id="btnPinsStartAll" type="button">Start All</button>
            <button class="btn" id="btnPinsPauseAll" type="button">Pause All</button>
            <button class="btn danger" id="btnPinsResetAll" type="button">Reset All</button>
          </div>
        </div>
        <div class="card-body">
          <div id="pinnedTimers" class="pinned-grid"><!-- cards injected here --></div>
          <div id="pinnedEmpty" class="text-muted" style="display:none">No pinned timers yet.</div>
        </div>
      </div>

      <!-- Timer Log -->
      <div class="card mt-4">
        <div class="card-header"><h5>Timer Log</h5></div>
        <div class="card-body">
          <div id="logSearchBar" style="display:flex;gap:.75rem;align-items:center;margin-bottom:.75rem;flex-wrap:wrap">
            <label style="font-weight:600">
              Search athlete:
              <input id="logSearch" type="text" placeholder="Type name…" style="margin-left:.5rem;padding:.35rem 1rem;border:1px solid #cfe0ff;border-radius:8px">
            </label>
            <button id="logSearchClear" class="btn" type="button">Clear</button>
            <span id="logSearchCount" class="text-muted" style="margin-left:.25rem"></span>
          </div>

          <table class="tk-table" id="logTable">
            <thead>
              <tr>
                <th>Start</th>
                <th>Stop</th>
                <th>Competition</th>
                <th>Event</th>
                <th>Flight</th>
                <th>Athlete</th>
                <th>Attempt #</th>
                <th>Action</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/timekeeper.js') }}"></script>
{% endblock %}
