{% extends "base.html" %}
{% block title %}Timekeeper{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/timekeeper.css') }}">
<style>
  /* Sortable Drag-and-Drop Styles */
  .sortable-ghost {
    opacity: 0.4;
    background: #e2e8f0 !important;
  }
  
  .sortable-chosen {
    transform: rotate(2deg);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .attempt-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s;
  }
  
  /* Notification Animations */
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  
  /* Pulse animation for Apply button */
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
  }
</style>

<!-- Fixed Mobile Control Dock (proxied buttons) -->
<div class="control-dock" aria-label="Timer controls">
  <button class="dock-btn start"  onclick="document.getElementById('btnStart').click()">▶</button>
  <button class="dock-btn pause"  onclick="document.getElementById('btnPause').click()">⏸</button>
  <button class="dock-btn stop"   onclick="document.getElementById('btnBarLeft').click()">■</button>
  <button class="dock-btn reset"  onclick="document.getElementById('btnReset').click()">↺</button>
</div>

<div class="container-fluid tk-v1">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">
        <span class="ico"></span> Timekeeper Dashboard
      </h1>

      <!-- Flight selector toolbar (top only) -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Select Flight</h5>
        </div>
        <div class="card-body">
          <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center">
            <label>Competition
              <select id="selComp" style="min-width:220px; margin-left:.5rem"></select>
            </label>
            <label>Event
              <select id="selEvent" style="min-width:220px; margin-left:.5rem" disabled></select>
            </label>
            <label>Flight
              <select id="selFlight" style="min-width:220px; margin-left:.5rem" disabled></select>
            </label>
            <button id="selGo" class="btn primary" disabled>Load</button>
          </div>
        </div>
      </div>

      <!-- Selected Flight -->
      <div class="card" id="tk-available-card" style="display:none">
        <div class="card-header">
          <h5><span class="ico"></span> Selected Flight</h5>
        </div>
        <div class="card-body" id="tk-competitions-body">
          <div class="text-center py-5" id="tk-competitions-empty">
            <div class="muted-ico"></div>
            <h4 class="text-muted">No selection</h4>
            <p class="text-muted">Choose a competition, event, and flight above.</p>
          </div>

          <!-- Summary -->
          <div id="tk-selected-summary" class="selected-wrap" style="display:none"></div>

          <!-- Athlete & Attempt chooser -->
          <div id="tk-athlete-editor" style="margin-top:1rem; display:none">
            <div style="display:flex; gap:.75rem; align-items:center; flex-wrap:wrap">
              <label style="font-weight:600">
                Athlete:
                <select id="athleteSelect"
                        style="margin-left:.5rem; min-width:260px; padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px;"
                        disabled>
                  <option value="">Select athlete…</option>
                </select>
              </label>

              <label style="font-weight:600">
                Attempt:
                <select id="attemptSelect"
                        style="margin-left:.5rem; min-width:120px; padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px;"
                        disabled>
                  <option value="">Select…</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                </select>
              </label>

              <button class="btn" id="btnReloadAthletes" type="button">Reload</button>
              <button class="btn" id="btnAthleteApply" type="button">Apply</button>
              <button class="btn btn-success" id="btnNextAthlete" type="button" style="background: #28a745; color: white;">Next</button>
              <span id="athleteApplied" class="text-muted" style="margin-left:.5rem"></span>

              <!-- TEMP compat input (hidden) -->
              <input id="athleteName" type="text" value="" style="display:none">
            </div>
          </div>

          <!-- Attempt Order Management Section -->
          <div id="tk-attempt-order-section" style="margin-top:2rem; display:none">
            <h4 style="margin-bottom:1rem; color:#2c5282">Attempt Order Management</h4>
            <p style="color:#718096; margin-bottom:1rem; padding:.75rem; background:#ebf8ff; border-left:4px solid #4299e1; border-radius:4px">
              <strong>ℹ️ Info:</strong> Drag athlete boxes to reorder, or use the buttons below to sort automatically. All changes are saved automatically.
            </p>
            
            <!-- Attempt Filter Controls -->
            <div style="display:flex; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; align-items:center">
              <div>
                <label style="font-weight:600; margin-right:.5rem">Filter by Athlete:</label>
                <input type="text" id="tk-athlete-name-filter" placeholder="Search athlete name..." 
                       style="padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px; min-width:200px">
              </div>
              <div>
                <label style="font-weight:600; margin-right:.5rem">Filter by Status:</label>
                <select id="tk-attempt-status-filter" style="padding:.35rem 1rem; border:1px solid #cfe0ff; border-radius:8px">
                  <option value="">All Status</option>
                  <option value="waiting">Waiting</option>
                  <option value="in-progress">In Progress</option>
                  <option value="finished">Finished</option>
                </select>
              </div>
              <button class="btn" id="tk-clear-filters" type="button" style="background:#718096; color:white">Clear Filters</button>
            </div>
            
            <!-- Attempt Control Buttons -->
            <div style="display:flex; gap:.5rem; margin-bottom:1rem; flex-wrap:wrap">
              <button class="btn" id="tk-sort-by-weight" type="button" style="background:#4a5568; color:white">Sort by Weight</button>
              <button class="btn" id="tk-sort-by-name" type="button" style="background:#4a5568; color:white">Sort by Name</button>
              <button class="btn" id="tk-randomize-order" type="button" style="background:#4a5568; color:white">Randomize Order</button>
              <button class="btn" id="tk-generate-test-attempts" type="button" style="background:#3182ce; color:white">Generate Test Attempts</button>
              <button class="btn" id="tk-mark-first-completed" type="button" style="background:#d69e2e; color:white">Mark First as Completed</button>
              <button class="btn" id="tk-refresh-attempts" type="button" style="background:#38b2ac; color:white">Refresh</button>
            </div>
            
            <!-- Attempt Order List -->
            <div id="tk-attempt-order-list" style="margin-top:1rem">
              <!-- Attempt order will be displayed here -->
            </div>
          </div>

        </div>
      </div>

      <!-- Timer Controls -->
      <div class="card mt-4 hide-on-mobile">
        <div class="card-header">
          <h5><span class="ico"></span> Timer Controls</h5>
        </div>
        <div class="card-body">
          <div class="tc-grid">
            <button class="tile tile--start" id="btnStart" aria-label="Start Timer">
              <span class="tile-ico">▶</span><span class="tile-title">Start</span>
            </button>
            <button class="tile tile--pause" id="btnPause" aria-label="Pause Timer">
              <span class="tile-ico">⏸</span><span class="tile-title">Pause</span>
            </button>
            <button class="tile tile--stop" id="btnBarLeft" aria-label="Stop Timer">
              <span class="tile-ico">■</span><span class="tile-title">Stop</span>
            </button>
            <button class="tile tile--reset" id="btnReset" aria-label="Reset Timer">
              <span class="tile-ico">↺</span><span class="tile-title">Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden compatibility controls (attempt only; break removed) -->
      <div class="visually-hidden">
        <button id="btnResume"></button>
        <button id="btnAdd10"></button>
        <button id="btnSub10"></button>
        <button id="btn60"></button>
        <button id="btn120"></button>
        <input type="number" id="attemptSetSec" value="{{ default_attempt_seconds or 60 }}">
        <button id="btnApplyAttempt"></button>
        <label><input type="checkbox" id="chkAnn">Ann</label>
        <label><input type="checkbox" id="chkLoaded">Load</label>
      </div>

      <!-- Current Status -->
      <div class="card mt-4">
        <div class="card-header"><h5>Attempt Timer</h5></div>
        <div class="card-body status-wrap">
          <div class="status-top only-timer">
            <div class="status-top__timer">
              <div class="display-time display-time--hero" id="attemptClock">00:00:00</div>
              <div class="muted-sub">Current Timer</div>
            </div>
          </div>

          <div class="attempt-controls">
            <button id="btnAttemptToggle" class="btn" type="button">Countdown: Off</button>
            <button id="btnAttemptEdit" class="btn" type="button" style="margin-left:.5rem">✎ Edit Time</button>
            <div class="timer-set attempt-set" id="attemptSetRow" style="display:none">
              <label for="attemptHMS"><strong>Set</strong></label>
              <input id="attemptHMS" class="input-hms" type="text" inputmode="numeric"
                     placeholder="HH:MM:SS" value="00:01:00">
              <button class="btn" id="btnAttemptApply">Apply</button>
            </div>
          </div>

          <!-- NOTE: Global Break panel removed; we now use per-athlete Rest inside pinned cards -->
        </div>
      </div>

      <!-- Break Timer (Event/Flight Breaks) -->
      <div class="card mt-4" id="breakTimerCard" style="display:none">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
          <h5 id="breakTimerTitle">Break Timer</h5>
          <div style="display:flex;gap:.5rem;">
            <button class="btn" id="btnBreakEdit" type="button">✎ Edit</button>
            <button class="btn" id="btnBreakStart" type="button">Start</button>
            <button class="btn" id="btnBreakPause" type="button">Pause</button>
            <button class="btn danger" id="btnBreakReset" type="button">Reset</button>
            <button class="btn" id="btnBreakDismiss" type="button">✕ Dismiss</button>
          </div>
        </div>
        <div class="card-body" style="text-align:center">
          <div id="breakTimerMessage" style="font-size:1.25rem; color:#2c5282; margin-bottom:1rem; font-weight:600"></div>
          <div id="breakTimerClock" style="font-size:4rem; font-weight:700; color:#2d3748; padding:2rem; background:#ebf8ff; border-radius:12px; margin-bottom:1rem">00:00:00</div>
          <div id="breakTimerSubtext" style="color:#718096; font-size:1rem"></div>
          <div id="breakTimerEditRow" style="display:none; margin-top:1rem; padding:1rem; background:#f7fafc; border-radius:8px;">
            <label style="font-weight:600; margin-right:.5rem">Set Time:</label>
            <input id="breakTimerHMS" type="text" placeholder="HH:MM:SS" style="padding:.5rem; border:1px solid #cbd5e0; border-radius:4px; margin-right:.5rem">
            <button class="btn" id="btnBreakApply" type="button">Apply</button>
          </div>
        </div>
      </div>

      <!-- Timer Log -->
      <div class="card mt-4">
        <div class="card-header"><h5>Timer Log</h5></div>
        <div class="card-body">
          <div id="logSearchBar" style="display:flex;gap:.75rem;align-items:center;margin-bottom:.75rem;flex-wrap:wrap">
            <label style="font-weight:600">
              Search athlete:
              <input id="logSearch" type="text" placeholder="Type name…" style="margin-left:.5rem;padding:.35rem 1rem;border:1px solid #cfe0ff;border-radius:8px">
            </label>
            <button id="logSearchClear" class="btn" type="button">Clear</button>
            <span id="logSearchCount" class="text-muted" style="margin-left:.25rem"></span>
          </div>

          <table class="tk-table" id="logTable">
            <thead>
              <tr>
                <th>Start</th>
                <th>Stop</th>
                <th>Competition</th>
                <th>Event</th>
                <th>Flight</th>
                <th>Athlete</th>
                <th>Attempt #</th>
                <th>Action</th>
                <th>Duration</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/timekeeper.js') }}"></script>
{% endblock %}
